<?xml version='1.0' encoding='utf-8'?>
<odoo>
    <data>
        <!-- View Tree untuk Tagihan Orangtua -->
        <record id="tagihan_orangtua_view_tree" model="ir.ui.view">
            <field name="name">account.move.tagihan.view.list</field>
            <field name="model">account.move</field>
            <field name="arch" type="xml">
                <list create="false" edit="false" delete="false" default_order="invoice_date desc">
                    <field name="name"/>
                    <field name="invoice_date" string="Tgl Tagihan"/>
                    <field name="siswa_id"/>
                    <field name="product_names" string="Produk"/>
                    <field name="ruang_kelas_id"/>
                    <field name="total_tagihan" widget="monetary" string="Total Tagihan" sum="Total" options="{'no_symbol': True}"/>
                    <field name="telah_dibayar" widget="monetary" string="Telah Dibayar" sum="Total" options="{'no_symbol': True}"/>
                    <field name="sisa_tagihan" widget="monetary" string="Sisa Tagihan" sum="Total" options="{'no_symbol': True}"/>
                    <field name="payment_state"/>
                    <field name="currency_id" invisible="1" column_invisible="1"/>
                    <field name="company_currency_id" invisible="1" column_invisible="1"/>
                </list>
            </field>
        </record>

        <!-- Form View untuk Tagihan Orangtua -->
        <record id="tagihan_orangtua_view_form" model="ir.ui.view">
            <field name="name">account.move.tagihan.orangtua.view.form</field>
            <field name="model">account.move</field>
            <field name="inherit_id" ref="account.view_move_form"/>
            <field name="mode">primary</field>
            <field name="priority">100</field>
            <field name="arch" type="xml">
                <!-- Mengubah struktur group saja, sisanya menggunakan struktur view asli -->
                <xpath expr="//div[hasclass('oe_title')]" position="attributes">
                    <attribute name="invisible">1</attribute>
                </xpath>

                <xpath expr="//group[1]" position="replace">
                    <group string="Santri">
                        <group>
                            <field name="barcode" string="Kartu Santri" readonly="1"/>
                            <field name="siswa_id" string="Santri" readonly="1"/>
                            <field name="partner_id" invisible="1"/>
                            <field name="ruang_kelas_id" readonly="1"/>
                        </group>
                        <group>
                            <field name="kamar_id" readonly="1"/>
                            <field name="halaqoh_id" string="Halaqah" readonly="1"/>
                            <field name="musyrif_id" readonly="1"/>
                        </group>
                    </group>

                    <group string="Tagihan">
                        <group>
                            <field name="name" readonly="1"/> 
                            <field name="invoice_date" string="Tgl Tagihan" readonly="1"/>
                            <field name="invoice_date_due" readonly="1"/>
                            <field name="journal_id" readonly="1"/>
                        </group>
                        <group>
                            <field name="orangtua_id" readonly="1"/>
                            <field name="tahunajaran_id" readonly="1"/>
                            <field name="periode_id" readonly="1"/>
                            <field name="komponen_id" readonly="1"/>
                        </group>
                    </group>

                    <group>
                    </group>
                </xpath>
            </field>
        </record>

        <!-- Action Window untuk Tagihan Orangtua -->
        <record id="tagihan_orangtua_action" model="ir.actions.act_window">
            <field name="name">Tagihan</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">account.move</field>
            <field name="view_mode">list,form,kanban</field>
            <field name="context">{'default_move_type': 'out_invoice', 'search_default_filter_by_blm_lunas': 1}</field>
            <field name="domain">[('move_type', '=', 'out_invoice'), ('orangtua_id.partner_id.user_id','=',uid)]</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Belum ada tagihan untuk anak Anda
                </p>
            </field>
        </record>
        
        <!-- View Specific Actions -->
        <record id="list_tagihan_orangtua_action" model="ir.actions.act_window.view">
            <field name="sequence" eval="1"/>
            <field name="view_mode">list</field>
            <field name="view_id" ref="tagihan_orangtua_view_tree"/>
            <field name="act_window_id" ref="tagihan_orangtua_action"/>
        </record>
        
        <record id="form_tagihan_orangtua_action" model="ir.actions.act_window.view">
            <field name="sequence" eval="2"/>
            <field name="view_mode">form</field>
            <field name="view_id" ref="tagihan_orangtua_view_form"/>
            <field name="act_window_id" ref="tagihan_orangtua_action"/>
        </record>

        <!-- Filter untuk mencari tagihan yang belum lunas -->
        <record id="tagihan_orangtua_view_search" model="ir.ui.view">
            <field name="name">account.move.tagihan.orangtua.view.search</field>
            <field name="model">account.move</field>
            <field name="arch" type="xml">
                <search>
                    <field name="name"/>
                    <field name="siswa_id"/>
                    <field name="ruang_kelas_id"/>
                    <filter string="Belum Lunas" name="filter_by_blm_lunas" domain="[('payment_state', 'in', ('not_paid', 'partial'))]"/>
                    <filter string="Lunas" name="filter_by_lunas" domain="[('payment_state', '=', 'paid')]"/>
                    <group expand="0" string="Group By">
                        <filter string="Kelas" name="group_by_kelas" context="{'group_by': 'ruang_kelas_id'}"/>
                        <filter string="Status Pembayaran" name="group_by_payment_state" context="{'group_by': 'payment_state'}"/>
                        <filter string="Tanggal Tagihan" name="group_by_invoice_date" context="{'group_by': 'invoice_date'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- Menu Item -->
        <menuitem id="tagihan_orangtua_menu_act" name="Tagihan" parent="keuangan_menu_categ" action="tagihan_orangtua_action" sequence="10"/>
    </data>
</odoo>